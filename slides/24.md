layout: true

# A Real Life Servlet Application

---

### https://questioneer.cthiebaud.com/

.center[![questionner screenshot](/images/questionner.png)]

---

```bash
questionner
├── pom.xml
└── src
    └── main
        ├── java
        │   └── com
        │       └── cthiebaud
        │           └── questioneer
        │               ├── AdminServlet.java
        │               ├── PartialAnswerServlet.java
        │               ├── QuestioneerContextListener.java
        │               ├── QuestioneerSessionListener.java
        │               ├── QuestioneerWebSocket.java
        │               ├── QuestioneerWebSocketMessageType.java
        │               ├── QuestioneerWebSockets.java
        │               └── SubmitAnswersServlet.java
        ├── resources
        │   └── questions
        │       ├── m15.json
        │       ├── m16.json
        │       └── ...
        └── webapp
            ├── admin.jsp
            ├── admin².jsp
            ├── favicon.ico
            ├── header.jspf
            ├── hello.txt
            ├── index.jsp
            ├── m15.jsp
            ├── m16.jsp
            ├── ...
            └── questionnaire.jsp
```

---

### Servlet + Web Sockets

Extends the [WebSockets](https://github.com/athenaeum-brew/webapp-examples/tree/main/WebSockets) application we've seen in the previous module.

<div class="d-flex justify-content-between">
    <div>
        <img src="/images/questioneerwebsockets.png" alt="questioneerwebsockets">
    </div>
    <div>
        <img src="/images/questionner_admin.png" alt="questioneer_admin_">
    </div>
</div>

---

### Showcase of Techniques Used in a Servlet Application:

<small>
--

- **Servlet**: Demonstrating various HTTP message handling methods such as GET, POST, DELETE.

--

- **Listeners**:

  - **Application Listener**: Handling application-wide events and initialization.
  - **Session Listener**: Managing session-related events.
  - **Request Listener** (not covered): Monitoring request-related events.

--


- **Java Server Pages (JSP)**: Incorporating dynamic content generation with JSP technology.

--

- **Jakarta Standard Tag Library (JSTL)**: Utilizing standard tag libraries for JSP simplification.

- **Expression Language (EL)**  Lightweight scripting language for streamlined data access and manipulation within JSPs.

--

- **Request Forwarding**: Redirecting client requests to different resources within the application.

--

- **JSP Include Action**: Dynamically include the content of another JSP page within the current JSP page during request processing.

</small>

---

### Servlet 

Servlets are Java classes that extend the functionality of a web server. They handle incoming HTTP requests and generate dynamic responses based on the request parameters. Servlets can handle various HTTP methods such as GET, POST, DELETE, etc. 

--

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/java/com/cthiebaud/questioneer/PartialAnswerServlet.java">PartialAnswerServlet.java</a>
</div>
```java
@WebServlet("/partial")
public class PartialAnswerServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    public static AtomicInteger goods = new AtomicInteger(0);
    public static AtomicInteger bads = new AtomicInteger(0);
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        JSONParser parser = new JSONParser();
        try {
            JSONObject json = (JSONObject) parser.parse(request.getReader());
            boolean isCorrect = (boolean) json.get("isCorrect");
            if (isCorrect) {
                QuestioneerWebSockets.INSTANCE.broadcast(QuestioneerWebSocketMessageType.GOOD, String.format("%d", goods.incrementAndGet()));
            } else {
                QuestioneerWebSockets.INSTANCE.broadcast( QuestioneerWebSocketMessageType.BAD, String.format("%d", bads.incrementAndGet()));
            }
            response.setContentType("text/plain");
            response.getWriter().write("ok");
        } catch (Exception e) {
            e.printStackTrace();
            response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
        }
    }
}
```

---

### Listeners

**Application listeners** respond to application-wide events and initialization. They are used to perform tasks like setting up database connections, initializing global resources, and managing application-wide settings.

--

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/java/com/cthiebaud/questioneer/QuestioneerContextListener.java">QuestioneerContextListener.java</a>
</div>
```java
@WebListener
public class QuestioneerContextListener implements ServletContextListener {
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        ServletContext context = sce.getServletContext();
        String jspDir = "/"; // directory containing JSP files
        String realPath = context.getRealPath(jspDir);
        List<String> jspFiles = new ArrayList<>();
        if (realPath != null) {
            File dir = new File(realPath);
            if (dir.exists() && dir.isDirectory()) {
                File[] files = dir.listFiles((d, name) -> name.endsWith(".jsp") && name.startsWith("m"));
                if (files != null) {
                    for (File file : files) {
                        System.out.println(file);
                        jspFiles.add(context.getContextPath() + jspDir + file.getName());
                    }
                }
            }
        }
        // Sort the list alphabetically
        Collections.sort(jspFiles);
        context.setAttribute("jspFiles", List.copyOf(jspFiles));
    }
}```

---

### Listeners (cont.)

**Application listeners** respond to application-wide events and initialization. They are used to perform tasks like setting up database connections, initializing global resources, and managing application-wide settings.

**Session listeners** monitor and respond to session-related events in a web application. They handle tasks such as tracking user sessions, managing session attributes, and cleaning up resources when sessions expire or are invalidated.

**Request listeners** observe and react to individual HTTP request events within a web application. While less common than application and session listeners, they can be used to perform actions such as logging request details, modifying request parameters, or enforcing access controls. 

---

### Java Server Pages (JSP)

Java Server Pages (JSP) is a technology used to create dynamic web pages by embedding Java code within HTML markup. JSP pages are compiled into servlets by the web container at runtime, allowing for the execution of Java code on the server side to generate dynamic content. 

---

### Java Server Pages (JSP)

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/webapp/questionnaire.jsp">questionnaire.jsp</a>
</div>
```java
<%@ page contentType="text/html;charset=UTF-8" language="html" %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quizz</title>
    <%@ include file="header.jspf" %>    
    (...)
</head>
<body>
    <div class="container my-3">
        <div style="float:right;">
            <a href="<%= application.getContextPath() %>" style="text-decoration: none; font-size: 32px;">⌂</a>
        </div>
        <h1 id="questionnaire-title"></h1>
        (...)        
    </div>
    <script>
        document.getElementById('questionnaire-title').innerText = "..."
        (...)
        const questionnaireJson = '<%= getQuestionnaireJson(request.getParameter("file")) %>'
        (...)
    </script>
</body>
</html>
<%@ page import="java.io.InputStream, org.json.simple.parser.JSONParser" %>
<%! 
public String getQuestionnaireJson(String file) { 
    JSONParser parser = new JSONParser();
    // Load the file from the classpath
    InputStream inputStream = getClass().getClassLoader().getResourceAsStream("/questions/" + file);    
    (...)
} 
%>
```

---

### Java Server Pages: Directives

<small>
<%@ is a directive tag in JavaServer Pages (JSP). It's used to specify directives that control various aspects of the JSP page translation and execution. There are three types of directives in JSP, and <%@ is the opening tag for all of them.

- <%@ page ... %> Page Directive: Sets various attributes and configuration options for the JSP page:
    - <%@ page contentType= ... %>
    - <%@ page import= ... %>
    - <%@ page session= ... %>
    - <%@ page errorPage= ... %>
    - etc.

- <%@ include ... %> Include Directive: Includes the content of another file during the JSP page's translation phase, essentially merging the content.

- <%@ taglib ... %> Taglib Directive: Declares a tag library containing custom tags for use in the JSP page.

These directive tags are processed by the Servlet container during translation of the JSP page into a servlet.
</small>

---

### Java Server Pages: Scriplets

<small>
 <% : scriptlet tags used to embed Java code within the JSP page.

- <% ... %> : Scriptlet Tag     
- <%! ... %> : Declaration Tag   
- <%= ... %> : Expression Tag    
- <%-- ... --%> : Comment Scriptlet 

These scriptlet tags are processed by the JSP container during translation of the JSP page into a servlet. They allow developers to include dynamic content, perform logic, and interact with server-side resources within the JSP page. 

However, it's worth noting that scriptlet tags are considered less desirable in modern web development due to mixing of presentation and logic concerns, and the trend is towards using JSP expression language (EL) and custom tags for better separation of concerns.
</small>

---

### Jakarta Standard Tag Library (JSTL) and Expression Language (EL)


**The Jakarta Standard Tag Library** (JSTL) is a collection of custom tags that simplify common tasks in JSP development. JSTL provides tags for iteration, conditionals, formatting, internationalization, and database access, among others. By encapsulating common functionality into reusable tags, JSTL reduces the need for Java code (scriptlet) in JSP pages.

**Expression Language (EL)** is a scripting language used in JavaServer Pages (JSP) to access and manipulate data within the JSP page. EL provides a simplified syntax for accessing objects, properties, and methods without the need for Java code (scriptlet). EL expressions are enclosed within ${} or #{} delimiters

---

### Jakarta Standard Tag Library (JSTL) and Expression Language (EL)

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/webapp/index.jsp">index.jsp</a>
</div>
```html
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fn" uri="jakarta.tags.functions" %>
(...)
    <tbody>
        <c:forEach var="file" items="${jspFiles}">
            <!-- Extract the number using substring and indexOf functions -->
            <c:set var="mIndex" value="${fn:indexOf(file, 'm')}" />
            <c:set var="dotIndex" value="${fn:indexOf(file, '.jsp')}" />
            <c:set var="number" value="${fn:substring(file, mIndex + 1, dotIndex)}" />
            <!-- Construct the module string and the lecture link -->
            <c:set var="slidesString" value="Slides ${number}" />
            <c:set var="quizzString" value="Quizz ${number}" />
            <c:set var="lectureLink" value="https://athenaeum.cthiebaud.com/slides/?${number}.md" />
            <!-- Display the row in the table -->
            <tr id="tr${number}">
                <td><a href="${lectureLink}">${slidesString}</a></td>
                <td>&nbsp;</td>
                <td><a href="${file}">${quizzString}</a></td>
            </tr>
        </c:forEach>
    </tbody>

(...)
```
---

### ~~Jakarta Standard Tag Library (JSTL)~~ and Expression Language (EL)

```java
    <tbody>
        <%
            List<String> jspFiles = (List<String>) application.getAttribute("jspFiles");
            if (jspFiles != null) {
                for (String file : jspFiles) {
                    // Extract the number using substring and indexOf functions
                    int mIndex = file.indexOf('m');
                    int dotIndex = file.indexOf(".jsp");
                    String number = file.substring(mIndex + 1, dotIndex);
                    // Construct the module string and the lecture link
                    String slidesString = "Slides " + number;
                    String quizzString = "Quizz " + number;
                    String lectureLink = "https://athenaeum.cthiebaud.com/slides/?" + number + ".md";
        %>          <!-- Display the row in the table -->
                    <tr id="tr${number}">
                        <td><a href="${lectureLink}">${slidesString}</a></td>
                        <td>&nbsp;</td>
                        <td><a href="${file}">${quizzString}</a></td>
                    </tr>
        <%
                }
            }
        %>
    </tbody>
```

---

### Request Forwarding

Request forwarding is a technique used in web applications to redirect client requests to different resources within the application. It allows for centralized request handling and can be used to implement features such as URL rewriting, content filtering, and request preprocessing. 

--

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/webapp/m06.jsp">m06.jsp</a>
</div>

```html
<jsp:forward page="questionnaire.jsp">
    <jsp:param name="file" value="m06.json" />
</jsp:forward>
```
<small>
https://questioneer.cthiebaud.com/m06.jsp

is ~equivalent to 

https://questioneer.cthiebaud.com/questionnaire.jsp?file=m06.json
</small>

---

### JSP actions: 

```
<jsp:include>
<jsp:forward>
<jsp:param>
etc.
```
<small>
E.g, the **&lt;jsp:include&gt;** action is used to dynamically include the content of another JSP page within the current JSP page during request processing. This inclusion occurs at runtime, allowing for dynamic generation and processing of the included content.
</small>

--

<div class="font-monospace qwe">
    <a href="https://github.com/athenaeum-brew/questioneer/blob/main/src/main/webapp/admin².jsp">admin².jsp</a>
</div>

```html
<!DOCTYPE html>
<html>
<head>
    <%@ include file="header.jspf" %>
    <title>Dashboard²</title>
</head>
<body>
    <main class="container d-flex justify-content-evenly">
        <div>
            <jsp:include page="admin.jsp" ></jsp:include>
        </div>
        <div>
            <jsp:include page="admin.jsp" ></jsp:include>
        </div>
    </main>
</body>
```
<small class="font-monospace">
https://questioneer.cthiebaud.com/admin².jsp
</small>

---

### End of Journey

<img src="/images/beachsunset.jpg" alt="beach sunset" style="
    max-width: 42%;
    height: auto;
    float: right;
">
